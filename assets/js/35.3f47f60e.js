(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{593:function(s,t,n){"use strict";n.r(t);var a=n(13),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),n("blockquote",[n("p",[s._v("这是 “Python 工匠”系列的第 9 篇文章。"),n("a",{attrs:{href:"https://github.com/piglei/one-python-craftsman",target:"_blank",rel:"noopener noreferrer"}},[s._v("[查看系列所有文章]"),n("OutboundLink")],1)])]),s._v(" "),n("p",[s._v("模块（Module）是我们用来组织 Python 代码的基本单位。很多功能强大的复杂站点，都由成百上千个独立模块共同组成。")]),s._v(" "),n("p",[s._v("虽然模块有着不可替代的用处，但它有时也会给我们带来麻烦。比如，当你接手一个新项目后，刚展开项目目录。第一眼就看到了攀枝错节、难以理解的模块结构，那你肯定会想： "),n("em",[s._v("“这项目也太难搞了。”")]),s._v(" 😂")]),s._v(" "),n("p",[s._v("在这篇文章里，我准备了一个和模块有关的小故事与你分享。")]),s._v(" "),n("h2",{attrs:{id:"一个关于模块的小故事"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一个关于模块的小故事"}},[s._v("#")]),s._v(" 一个关于模块的小故事")]),s._v(" "),n("p",[s._v("小 R 是一个刚从学校毕业的计算机专业学生。半个月前，他面试进了一家互联网公司做 Python 开发，负责一个与用户活动积分有关的小项目。项目的主要功能是查询站点活跃用户，并为他们发送有关活动积分的通知： "),n("em",[s._v("“亲爱的用户，您好，您当前的活动积分为 x”")]),s._v("。")]),s._v(" "),n("p",[s._v("项目主要由 "),n("code",[s._v("notify_users.py")]),s._v(" 脚本和 "),n("code",[s._v("fancy_site")]),s._v(" 包组成，结构与各文件内容如下：")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("├── fancy_site\n│   ├── __init__.py\n│   ├── marketing.py        # 与市场活动有关的内容\n│   └── users.py            # 与用户有关的内容\n└── notify_users.py     # 脚本：发送积分通知\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("文件 "),n("code",[s._v("notify_users.py")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" fancy_site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("users "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" list_active_users\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" fancy_site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("marketing "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" query_user_points\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""获取所有的活跃用户，将积分情况发送给他们"""')]),s._v("\n    users "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" get_active_users"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    points "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" list_user_points"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("users"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" user "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" users"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        user"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("add_notification"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  <... 已省略 ...>")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("文件 "),n("code",[s._v("fancy_site/users.py")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" typing "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" List\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("User")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <... 已省略 ...>")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add_notification")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""为用户发送新通知"""')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("pass")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("list_active_users")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" List"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("User"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""查询所有活跃用户"""')]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("pass")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("文件："),n("code",[s._v("fancy_site/marketing.py")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" typing "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" List\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("users "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" User\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("query_user_points")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("users"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" List"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("User"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" List"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""批量查询用户活动积分"""')]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("send_sms")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("phone_number"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""为某手机号发送短信"""')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("只要在项目目录下执行 "),n("code",[s._v("python notify_user.py")]),s._v("，就能实现给所有活跃用户发送通知。")]),s._v(" "),n("h3",{attrs:{id:"需求变更"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#需求变更"}},[s._v("#")]),s._v(" 需求变更")]),s._v(" "),n("p",[s._v("但有一天，产品经理找过来说，光给用户发站内信通知还不够，容易被用户忽略。除了站内信以外，我们还需要同时给用户推送一条短信通知。")]),s._v(" "),n("p",[s._v("琢磨了五秒钟后，小 R 跟产品经理说："),n("em",[s._v("“这个需求可以做！”")]),s._v("。毕竟给手机号发送短信的 "),n("code",[s._v("send_sms()")]),s._v(" 函数早就已经有人写好了。他只要先给 "),n("code",[s._v("add_notification")]),s._v(" 方法添加一个可选参数 "),n("code",[s._v("enable_sms=False")]),s._v("，当传值为 "),n("code",[s._v("True")]),s._v(" 时调用 "),n("code",[s._v("fancy_site.marketing")]),s._v(" 模块里的 "),n("code",[s._v("send_sms")]),s._v(" 函数就行。")]),s._v(" "),n("p",[s._v("一切听上去根本没有什么难度可言，十分钟后，小 R 就把 "),n("code",[s._v("user.py")]),s._v(" 改成了下面这样：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导入 send_sms 模块的发送短信函数")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("marketing "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" send_sms\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("User")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <...> 相关初始化代码已省略")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add_notification")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" enable_sms"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""为用户添加新通知"""')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" enable_sms"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            send_sms"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mobile_number"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("但是，当他修改完代码，再次执行 "),n("code",[s._v("notify_users.py")]),s._v(" 脚本时，程序却报错了：")]),s._v(" "),n("div",{staticClass:"language-raw line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('Traceback (most recent call last):\n  File "notify_users.py", line 2, in <module>\n    from fancy_site.users import list_active_users\n  File .../fancy_site/users.py", line 3, in <module>\n    from .marketing import send_sms\n  File ".../fancy_site/marketing.py", line 3, in <module>\n    from .users import User\nImportError: cannot import name \'User\' from \'fancy_site.users\' (.../fancy_site/users.py)\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("错误信息说，无法从 "),n("code",[s._v("fancy_site.users")]),s._v(" 模块导入 "),n("code",[s._v("User")]),s._v(" 对象。")]),s._v(" "),n("h3",{attrs:{id:"解决环形依赖问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决环形依赖问题"}},[s._v("#")]),s._v(" 解决环形依赖问题")]),s._v(" "),n("p",[s._v("小 R 仔细分析了一下错误，发现错误是因为 "),n("code",[s._v("users")]),s._v(" 与 "),n("code",[s._v("marketing")]),s._v(" 模块之间产生的环形依赖关系导致的。")]),s._v(" "),n("p",[s._v("当程序在 "),n("code",[s._v("notify_users.py")]),s._v(" 文件导入 "),n("code",[s._v("fancy_site.users")]),s._v(" 模块时，"),n("code",[s._v("users")]),s._v(" 模块发现自己需要从 "),n("code",[s._v("marketing")]),s._v(" 模块那里导入 "),n("code",[s._v("send_sms")]),s._v(" 函数。而解释器在加载 "),n("code",[s._v("marketing")]),s._v(" 模块的过程中，又反过来发现自己需要依赖 "),n("code",[s._v("users")]),s._v(" 模块里面的 "),n("code",[s._v("User")]),s._v(" 对象。")]),s._v(" "),n("p",[s._v("如此一来，整个模块依赖关系成为了环状，程序自然也就没法执行下去了。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://www.zlovezl.cn/static/uploaded/2019/05/modules_before.png",alt:"modules_before"}})]),s._v(" "),n("p",[s._v("不过，没有什么问题能够难倒一个可以正常访问 Google 的程序员。小 R 随便上网一搜，发现这样的问题很好解决。因为 Python 的 import 语句非常灵活，他只需要 "),n("strong",[s._v("把在 users 模块内导入 send_sms 函数的语句挪到 "),n("code",[s._v("add_notification")]),s._v(" 方法内，延缓 import 语句的执行就行啦。")])]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("User")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <...> 相关初始化代码已省略")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add_notification")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" send_sms"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""为用户添加新通知"""')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 延缓 import 语句执行")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("marketing "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" send_sms\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("改动一行代码后，大功告成。小 R 简单测试后，发现一切正常，然后把代码推送了上去。不过小 R 还没来得及为自己点个赞，意料之外的事情发生了。")]),s._v(" "),n("p",[s._v("这段明明几乎完美的代码改动在 "),n("strong",[s._v("Code Review")]),s._v(" 的时候被审计人小 C 拒绝了。")]),s._v(" "),n("h3",{attrs:{id:"小-c-的疑问"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#小-c-的疑问"}},[s._v("#")]),s._v(" 小 C 的疑问")]),s._v(" "),n("p",[s._v("小 R 的同事小 C 是一名有着多年经验的 Python 程序员，他对小 R 说：“使用延迟 import，虽然可以马上解决包导入问题。但这个小问题背后隐藏了更多的信息。比如，"),n("strong",[s._v("你有没有想过 send_sms 函数，是不是已经不适合放在 marketing 模块里了？”")])]),s._v(" "),n("p",[s._v("被小 C 这么一问，聪明的小 R 马上意识到了问题所在。要在 "),n("code",[s._v("users")]),s._v(" 模块内发送短信，重点不在于用延迟导入解决环形依赖。而是要以此为契机，"),n("strong",[s._v("发现当前模块间依赖关系的不合理，拆分/合并模块，创建新的分层与抽象，最终消除环形依赖。")])]),s._v(" "),n("p",[s._v("认识清楚问题后，他很快提交了新的代码修改。在新代码中，他创建了一个专门负责通知与消息类的工具模块 "),n("code",[s._v("msg_utils")]),s._v("，然后把 "),n("code",[s._v("send_sms")]),s._v(" 函数挪到了里面。之后 "),n("code",[s._v("users")]),s._v(" 模块内就可以毫无困难的从 "),n("code",[s._v("msg_utils")]),s._v(" 模块中导入 "),n("code",[s._v("send_sms")]),s._v(" 函数了。")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("msg_utils "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" send_sms\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("新的模块依赖关系如下图所示：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://www.zlovezl.cn/static/uploaded/2019/05/modules_after.png",alt:"modules_afte"}})]),s._v(" "),n("p",[s._v("在新的模块结构中，整个项目被整齐的分为三层，模块间的依赖关系也变得只有"),n("strong",[s._v("单向流动")]),s._v("。之前在函数内部 "),n("code",[s._v("import")]),s._v(" 的“延迟导入”技巧，自然也就没有用武之地了。")]),s._v(" "),n("p",[s._v("小 R 修改后的代码获得了大家的认可，很快就被合并到了主分支。故事暂告一段落，那么这个故事告诉了我们什么道理呢？")]),s._v(" "),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),n("p",[s._v("模块间的循环依赖是一个在大型 Python 项目中很常见的问题，越复杂的项目越容易碰到这个问题。当我们在参与这些项目时，"),n("strong",[s._v("如果对模块结构、分层、抽象缺少应有的重视。那么项目很容易就会慢慢变得复杂无比、难以维护。")])]),s._v(" "),n("p",[s._v("所以，合理的模块结构与分层非常重要。它可以大大降低开发人员的心智负担和项目维护成本。这也是我为什么要和你分享这个简单故事的原因。“在函数内延迟 import” 的做法当然没有错，但我们更应该关注的是："),n("strong",[s._v("整个项目内的模块依赖关系与分层是否合理。")])]),s._v(" "),n("p",[s._v("最后，让我们再尝试从 小 R 的故事里强行总结出几个道理吧：")]),s._v(" "),n("ul",[n("li",[s._v("合理的模块结构与分层可以降低项目的开发维护成本")]),s._v(" "),n("li",[s._v("合理的模块结构不是一成不变的，应该随着项目发展调整")]),s._v(" "),n("li",[s._v("遇到问题时，不要选**“简单但有缺陷”"),n("strong",[s._v("的那个方案，要选")]),s._v("“麻烦但正确”**的那个")]),s._v(" "),n("li",[s._v("整个项目内的模块间依赖关系流向，应该是单向的，不能有环形依赖存在")])]),s._v(" "),n("p",[s._v("看完文章的你，有没有什么想吐槽的？请留言或者在 "),n("a",{attrs:{href:"https://github.com/piglei/one-python-craftsman",target:"_blank",rel:"noopener noreferrer"}},[s._v("项目 Github Issues"),n("OutboundLink")],1),s._v(" 告诉我吧。")]),s._v(" "),n("p",[n("RouterLink",{attrs:{to:"/docs/python-craftsman/10-a-good-player-know-the-rules.html"}},[s._v(">>>下一篇【10.做一个精通规则的玩家】")])],1),s._v(" "),n("p",[n("RouterLink",{attrs:{to:"/docs/python-craftsman/8-tips-on-decorators.html"}},[s._v("<<<上一篇【8.使用装饰器的技巧】")])],1),s._v(" "),n("h2",{attrs:{id:"附录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#附录"}},[s._v("#")]),s._v(" 附录")]),s._v(" "),n("ul",[n("li",[s._v("题图来源: Photo by Ricardo Gomez Angel on Unsplash")]),s._v(" "),n("li",[s._v("更多系列文章地址：https://github.com/piglei/one-python-craftsman")])]),s._v(" "),n("p",[s._v("系列其他文章：")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://github.com/piglei/one-python-craftsman",target:"_blank",rel:"noopener noreferrer"}},[s._v("所有文章索引 [Github]"),n("OutboundLink")],1)]),s._v(" "),n("li",[n("a",{attrs:{href:"https://www.zlovezl.cn/articles/python-else-block-secrets/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Python 工匠：编写条件分支代码的技巧"),n("OutboundLink")],1)]),s._v(" "),n("li",[n("a",{attrs:{href:"https://www.zlovezl.cn/articles/three-rituals-of-exceptions-handling/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Python 工匠：异常处理的三个好习惯"),n("OutboundLink")],1)]),s._v(" "),n("li",[n("a",{attrs:{href:"https://www.zlovezl.cn/articles/two-tips-on-loop-writing/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Python 工匠：编写地道循环的两个建议"),n("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=e.exports}}]);